<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videregående Prosjekt (PvP)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- GUN.JS ONLY (No SEA/Encryption to avoid CSP errors) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1235/gun.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
            overflow: hidden; 
            user-select: none;
        }

        /* Animations */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 25px #f87171; } }
        @keyframes blur-spin { 0% { filter: blur(0); transform: translateY(0); } 50% { filter: blur(2px); transform: translateY(-10px); } 100% { filter: blur(0); transform: translateY(0); } }

        .feide-loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1f4698;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .feide-success {
            display: none;
            color: #fff;
            background-color: #22c55e;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            align-items: center;
            justify-content: center;
            animation: popIn 0.3s ease-out;
        }

        /* Modal Transitions */
        .modal { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }

        /* Wheel Styles */
        .wheel-wrapper { position: relative; width: 300px; height: 300px; margin: 0 auto; border-radius: 50%; border: 4px solid #f59e0b; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .wheel-spinner { width: 100%; height: 100%; position: relative; border-radius: 50%; transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .wheel-bg { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient( #f97316 0deg 45deg, #ef4444 45deg 90deg, #3b82f6 90deg 135deg, #22c55e 135deg 180deg, #eab308 180deg 225deg, #a855f7 225deg 270deg, #ec4899 270deg 315deg, #6366f1 315deg 360deg ); }
        .wheel-icon { position: absolute; top: 50%; left: 50%; width: 40px; height: 140px; transform-origin: bottom center; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding-top: 10px; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-left: -20px; margin-top: -140px; }
        
        /* Slots */
        .slot-spinning { animation: blur-spin 0.1s infinite linear; }

        /* PvP Selected State */
        .pvp-selected { border: 4px solid #3b82f6; background-color: #1e3a8a; transform: scale(1.05); }
        .pulse-border { animation: pulse-glow 2s infinite; }
        .room-item:hover { border-color: #3b82f6; background-color: #1e293b; }

        /* Radio Player */
        #radio-player {
            transition: transform 0.3s ease-in-out;
        }
        #radio-player.minimized {
            transform: translateY(100%);
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col">

    <!-- LANDING PAGE -->
    <div id="landing-page" class="flex-grow flex flex-col items-center justify-center p-4 relative z-10">
        <div class="text-center mb-12">
            <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-4 animate-pulse">
                Videregående Gambling
            </h1>
            <p class="text-slate-400 text-lg">Fordi stipendet varer ikke evig.</p>
        </div>

        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-6">Start spillingen nå</h2>
            
            <button onclick="openModal('login-modal')" class="group relative w-full flex items-center justify-center bg-white hover:bg-gray-100 text-slate-800 font-semibold py-3 px-4 rounded-lg border border-gray-300 shadow-sm transition-all duration-200">
                <span class="absolute left-4 flex items-center">
                    <!-- Original Feide SVG -->
                    <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 113.71 39" class="h-6 w-auto">
                        <defs><style>.cls-1{fill:#1f4698;}</style></defs>
                        <title>Horisontal_Feide</title>
                        <rect class="cls-1" x="27.99" y="20.34" width="4.24" height="10.18"/>
                        <polygon class="cls-1" points="18.23 23.31 13.99 23.31 13.99 34.76 4.24 34.76 4.24 20.34 0 20.34 0 35.61 0.02 35.61 0.02 39 32.23 39 32.23 34.76 18.23 34.76 18.23 23.31"/>
                        <circle class="cls-1" cx="16.11" cy="16.53" r="2.54"/>
                        <path class="cls-1" d="M16.11,4.24A11.87,11.87,0,0,1,28,16.1h4.25A16.11,16.11,0,0,0,0,16.1H4.25A11.87,11.87,0,0,1,16.11,4.24Z"/>
                        <polygon points="53.32 21.59 45.61 21.59 45.61 15.48 55.7 15.48 55.7 12.07 41.98 12.07 41.98 34.75 45.61 34.75 45.61 25.01 53.32 25.01 53.32 21.59"/>
                        <path d="M77.79,10.08a2.5,2.5,0,1,0,2.5,2.5A2.5,2.5,0,0,0,77.79,10.08Z"/>
                        <polygon points="72.51 17.75 72.51 21.17 75.98 21.17 75.98 31.27 71.67 31.27 71.67 34.69 81.9 34.69 81.9 31.27 79.61 31.27 79.61 17.75 72.51 17.75"/>
                        <path d="M97.52,34.69V10.46H93.89v8.83L93.65,19a4.09,4.09,0,0,0-3.31-1.64c-3.41,0-5.89,2.74-5.89,6.53v4.72c0,3.79,2.48,6.54,5.89,6.54a4.1,4.1,0,0,0,3.31-1.65l.24-.32v1.54Zm-3.65-4.6A3.34,3.34,0,0,1,91,31.7a2.83,2.83,0,0,1-2.91-3.12V23.86A2.83,2.83,0,0,1,91,20.74a3.34,3.34,0,0,1,2.88,1.65l0,0v7.64Z"/>
                        <path d="M69.21,27.84V23.31c0-3.54-2.74-6.11-6.53-6.11s-6.54,2.57-6.54,6.11v5.58c0,3.48,2.84,6.1,6.61,6.1a6.54,6.54,0,0,0,6.11-3.72L65.5,29.83a2.75,2.75,0,0,1-2.75,1.93,2.84,2.84,0,0,1-3-2.87V27.84Zm-9.44-4.53a2.91,2.91,0,0,1,5.81,0v1.33H59.77Z"/>
                        <path d="M113.71,27.84V23.31c0-3.54-2.75-6.11-6.54-6.11s-6.53,2.57-6.53,6.11v5.58c0,3.48,2.84,6.1,6.61,6.1a6.55,6.55,0,0,0,6.11-3.72L110,29.83a2.76,2.76,0,0,1-2.75,1.93,2.83,2.83,0,0,1-3-2.87V27.84Zm-9.44-4.53a2.91,2.91,0,0,1,5.81,0v1.33h-5.81Z"/>
                    </svg>
                </span>
                Logg inn med Feide
            </button>
            <p class="mt-4 text-xs text-slate-500">Ikke tilknyttet Sikt eller Utdanningsdirektoratet.</p>
        </div>
    </div>

    <!-- MAIN DASHBOARD (Hidden until login) -->
    <div id="dashboard" class="hidden flex-col h-screen overflow-y-auto pb-24">
        <!-- Header -->
        <header class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center w-full">
                <div class="flex items-center gap-2">
                    <span class="text-orange-500 font-black text-xl tracking-tighter">AKADEMIET<span class="text-white">BET</span></span>
                </div>
                
                <div class="flex items-center gap-2 md:gap-4">
                    <button onclick="openModal('add-funds-modal')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-full text-xs md:text-sm font-bold flex items-center gap-1 transition-all">
                        <i data-lucide="send" class="w-4 h-4"></i> Send Faktura
                    </button>
                    <div class="bg-slate-900 px-4 py-1.5 rounded-full border border-slate-700 flex items-center gap-2">
                        <i data-lucide="coins" class="text-yellow-400 w-4 h-4"></i>
                        <span id="user-balance" class="font-mono font-bold text-green-400">0 kr</span>
                    </div>
                    <div class="hidden md:block text-slate-300 text-sm">
                        <span class="text-slate-500">Elev:</span> <span id="display-username" class="font-semibold"></span>
                    </div>
                    <button onclick="openModal('settings-modal')" class="text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Grid -->
        <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
            
            <!-- PVP SECTION -->
            <div class="mb-10">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-500 flex items-center gap-2">
                        <i data-lucide="swords" class="text-red-500"></i> PvP Arena
                    </h2>
                    <button onclick="openLobby()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg animate-pulse">
                        Åpne Lobby / Finn Rom
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- RPS -->
                    <div class="bg-slate-800 rounded-xl overflow-hidden border border-red-500/50 hover:border-red-500 transition-all cursor-pointer group shadow-lg relative" onclick="openPvPSetup('rps')">
                        <div class="h-24 bg-gradient-to-r from-slate-900 to-red-900/50 flex items-center justify-between px-6 relative">
                            <i data-lucide="hand" class="w-10 h-10 text-slate-400 -rotate-12"></i>
                            <div class="text-xl font-black text-white italic">VS</div>
                            <i data-lucide="scissors" class="w-10 h-10 text-red-500 rotate-12"></i>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold mb-1 text-white text-sm">Stein, Saks, Papir</h3>
                            <p class="text-slate-400 text-[10px]">Utfordre en venn.</p>
                        </div>
                    </div>

                    <!-- High Card -->
                    <div class="bg-slate-800 rounded-xl overflow-hidden border border-blue-500/50 hover:border-blue-500 transition-all cursor-pointer group shadow-lg relative" onclick="openPvPSetup('card')">
                        <div class="h-24 bg-gradient-to-r from-slate-900 to-blue-900/50 flex items-center justify-center relative">
                            <div class="flex -space-x-3">
                                <div class="w-8 h-12 bg-white rounded border border-gray-300 transform -rotate-6"></div>
                                <div class="w-8 h-12 bg-blue-600 rounded border border-blue-400 transform rotate-6 flex items-center justify-center text-white font-bold text-xs">K</div>
                            </div>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold mb-1 text-white text-sm">Høyeste Kort</h3>
                            <p class="text-slate-400 text-[10px]">Høyest kort vinner.</p>
                        </div>
                    </div>

                     <!-- Dice Duel -->
                     <div class="bg-slate-800 rounded-xl overflow-hidden border border-green-500/50 hover:border-green-500 transition-all cursor-pointer group shadow-lg relative" onclick="openPvPSetup('dice')">
                        <div class="h-24 bg-gradient-to-r from-slate-900 to-green-900/50 flex items-center justify-center gap-2 relative">
                            <i data-lucide="dice-5" class="w-8 h-8 text-white animate-bounce"></i>
                            <i data-lucide="dice-3" class="w-8 h-8 text-green-500"></i>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold mb-1 text-white text-sm">Terning-Duell</h3>
                            <p class="text-slate-400 text-[10px]">Høyest sum vinner.</p>
                        </div>
                    </div>

                </div>
            </div>

            <h2 class="text-2xl font-bold mb-6 text-slate-200">Solo Spill</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                <!-- Wheel Card -->
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-yellow-500 transition-all cursor-pointer group shadow-lg" onclick="openModal('wheel-modal')">
                    <div class="h-32 bg-gradient-to-br from-orange-900 to-slate-900 flex items-center justify-center relative">
                        <i data-lucide="aperture" class="w-16 h-16 text-yellow-500 group-hover:rotate-180 transition-transform duration-700"></i>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-1">Akademiet Hjulet</h3>
                        <p class="text-slate-400 text-xs">Hovedpremie: MacBook Air</p>
                    </div>
                </div>
                 <!-- Slots Card -->
                 <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-purple-500 transition-all cursor-pointer group shadow-lg" onclick="openModal('slots-modal')">
                    <div class="h-32 bg-gradient-to-br from-purple-900 to-slate-900 flex items-center justify-center relative">
                        <div class="flex gap-2 text-white group-hover:animate-bounce">
                            <i data-lucide="cherry" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-1">Lærerværelset</h3>
                        <p class="text-slate-400 text-xs">Tre like gir storgevinst!</p>
                    </div>
                </div>
                 <!-- Blackjack Card -->
                 <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-green-600 transition-all cursor-pointer group shadow-lg" onclick="openModal('blackjack-modal')">
                    <div class="h-32 bg-gradient-to-br from-green-900 to-slate-900 flex items-center justify-center relative">
                        <div class="text-5xl font-bold text-green-500 opacity-80 group-hover:text-green-400">21</div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-1">Rektors Blackjack</h3>
                        <p class="text-slate-400 text-xs">Slå huset uten å sprekke.</p>
                    </div>
                </div>
                <!-- Mines Card -->
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 hover:border-blue-500 transition-all cursor-pointer group shadow-lg" onclick="openModal('mines-modal')">
                    <div class="h-32 bg-gradient-to-br from-blue-900 to-slate-900 flex items-center justify-center relative">
                        <i data-lucide="bomb" class="w-16 h-16 text-blue-500"></i>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-1">Fraværsgrensa</h3>
                        <p class="text-slate-400 text-xs">Unngå minene (anmerkning).</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="mt-12 bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="backpack" class="text-blue-400"></i>
                        Skolesekken
                    </h3>
                    <button onclick="openModal('claim-prize-modal')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-2 rounded-lg font-bold">
                        Send premier til skole
                    </button>
                </div>
                <div id="inventory-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

        </main>
    </div>

    <!-- RADIO PLAYER (Fixed HTTPS) -->
    <div id="radio-player" class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 p-2 md:p-4 z-50 flex items-center justify-between shadow-2xl">
        <div class="flex items-center gap-3">
            <button onclick="togglePlayMusic()" id="radio-btn" class="bg-blue-600 hover:bg-blue-500 rounded-full w-10 h-10 flex items-center justify-center text-white">
                <i data-lucide="play" id="radio-icon"></i>
            </button>
            <div class="flex flex-col">
                <span class="text-xs text-slate-400 uppercase font-bold">Radio (HTTPS)</span>
                <select id="radio-select" onchange="changeStation()" class="bg-transparent text-white font-bold text-sm focus:outline-none cursor-pointer">
                    <option value="https://lyd.nrk.no/nrk_radio_p3_mp3_h">NRK P3 (NO)</option>
                    <option value="https://stream.radioaalesund.no/ra128">Radio Ålesund (NO)</option>
                    <option value="https://lyd.nrk.no/nrk_radio_mp3_h">NRK P1 (NO)</option>
                    <option value="https://stream.p4.no/p4_mp3_hq">P4 Norge (NO)</option>
                    <option value="https://ais-sa5.cdnstream1.com/b22139_128mp3">80s Hits (Global Safe)</option>
                </select>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <i data-lucide="volume-2" class="w-4 h-4 text-slate-400"></i>
            <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this.value)" class="w-20 accent-blue-500">
        </div>
        <audio id="audio-element" src="https://lyd.nrk.no/nrk_radio_p3_mp3_h"></audio>
    </div>

    <!-- ===== GENERIC MODALS ===== -->

    <!-- Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="modal-content bg-white text-slate-900 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-700">Logg inn med Feide</h3>
                <button onclick="closeModal('login-modal')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Brukernavn</label>
                        <input type="text" id="username-input" required class="w-full px-3 py-2 border border-slate-300 rounded" placeholder="f.eks. ola.nordmann">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Passord</label>
                        <input type="password" id="password-input" required class="w-full px-3 py-2 border border-slate-300 rounded" placeholder="Hemmelig...">
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-[#1f4698] hover:bg-[#163475] text-white font-bold py-2 px-4 rounded transition-colors flex justify-center items-center h-10">
                        <span class="btn-text">Logg inn / Registrer</span>
                        <div class="feide-loader"></div>
                        <div class="feide-success"><i data-lucide="check" class="w-5 h-5"></i></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Bonus Modal -->
    <div id="bonus-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4">
        <div class="modal-content bg-gradient-to-br from-yellow-500 to-orange-600 text-white p-8 rounded-2xl shadow-2xl max-w-sm text-center">
            <div class="mb-4 flex justify-center"><i data-lucide="gift" class="w-16 h-16 text-yellow-100"></i></div>
            <h2 class="text-3xl font-extrabold mb-2">VELKOMSTBONUS!</h2>
            <p class="mb-6 font-semibold">Du får 500 NOK i startstipend!</p>
            <button onclick="closeModal('bonus-modal')" class="bg-white text-orange-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-orange-50 transition">TAKK!</button>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div id="add-funds-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="modal-content bg-slate-800 border border-slate-600 text-white rounded-xl w-full max-w-md">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold">Send Faktura til Skole</h3>
                <button onclick="closeModal('add-funds-modal')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Beløp (NOK)</label><input type="number" id="fund-amount" min="1" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white" placeholder="5000"></div>
                <button onclick="processFunds()" id="fund-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition-colors flex justify-center items-center h-10"><span id="fund-text">Send Faktura</span><i id="fund-spin" data-lucide="loader-2" class="animate-spin hidden"></i></button>
            </div>
        </div>
    </div>

    <!-- Claim Prize Modal -->
    <div id="claim-prize-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="modal-content bg-slate-800 border border-slate-600 text-white rounded-xl w-full max-w-md">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="font-bold">Hent Premier</h3><button onclick="closeModal('claim-prize-modal')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button></div>
            <div class="p-6 text-center space-y-4"><i data-lucide="truck" class="w-12 h-12 text-blue-400 mx-auto"></i><p class="text-sm text-slate-400">Vi sender premiene dine direkte til skolen.</p><input type="text" id="claim-school" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded text-white" placeholder="Navn på skole..."><button onclick="claimPrizes()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">Bekreft Sending</button></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="modal-content bg-slate-800 border border-slate-700 text-white rounded-xl w-full max-w-sm">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="font-bold">Innstillinger</h3><button onclick="closeModal('settings-modal')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button></div>
            <div class="p-6 space-y-4">
                <div class="bg-slate-900 p-3 rounded mb-4">
                    <div class="text-xs text-slate-500">Logget inn som</div>
                    <div class="font-bold" id="settings-username">-</div>
                    <div class="text-xs text-slate-500 mt-2">Data lagres offentlig (Uten kryptering)</div>
                </div>
                <button onclick="resetData()" class="w-full border border-red-500 text-red-500 hover:bg-red-500/10 font-bold py-2 px-4 rounded transition-colors flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Slett data og logg ut</button>
                <button onclick="logout()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded transition-colors">Logg ut</button>
            </div>
        </div>
    </div>

    <!-- Win Modal (Generic) -->
    <div id="win-modal" class="modal fixed inset-0 z-[70] flex items-center justify-center pointer-events-none">
        <div class="modal-content bg-yellow-400 text-yellow-900 p-6 rounded-xl shadow-2xl transform rotate-3 border-4 border-white text-center pointer-events-auto">
            <h2 class="text-3xl font-extrabold mb-2">GEVINST!</h2>
            <p id="win-message" class="text-xl font-bold">Du vant!</p>
            <button onclick="closeModal('win-modal')" class="mt-4 bg-white hover:bg-yellow-50 text-yellow-900 font-bold py-2 px-6 rounded-full shadow">Nice!</button>
        </div>
    </div>

    <!-- ===== PVP MODALS ===== -->

    <!-- Lobby Modal (NEW) -->
    <div id="lobby-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="modal-content bg-slate-900 border border-slate-600 rounded-2xl w-full max-w-2xl p-0 overflow-hidden flex flex-col max-h-[85vh]">
            <!-- Header -->
            <div class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="users" class="text-blue-400"></i> Multiplayer Lobby</h2>
                <button onclick="closeModal('lobby-modal')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-700 bg-slate-800/50">
                <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-3 text-sm font-bold text-blue-400 border-b-2 border-blue-400 bg-slate-800">Åpne Rom</button>
                <button onclick="switchTab('host')" id="tab-host" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-200">Opprett Nytt</button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto flex-grow bg-slate-900" id="lobby-content">
                
                <!-- Room List View -->
                <div id="view-list" class="space-y-3">
                    <div id="rooms-container">
                        <div class="text-center text-slate-500 py-8 animate-pulse">Leter etter rom...</div>
                    </div>
                </div>

                <!-- Host View -->
                <div id="view-host" class="hidden space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Rom Navn</label>
                        <input type="text" id="host-name" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white" placeholder="Eks: Gutta Boys">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Spill</label>
                        <select id="host-game" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white">
                            <option value="rps">Stein, Saks, Papir</option>
                            <option value="card">Høyeste Kort</option>
                            <option value="dice">Terning-Duell</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Innsats (NOK)</label>
                        <input type="number" id="host-bet" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white" value="100">
                    </div>
                    <button onclick="createPublicRoom()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg mt-4">
                        Start Rom
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- PvP Setup Modal (Manual Code) -->
    <div id="pvp-setup-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="modal-content bg-slate-900 border border-slate-600 rounded-2xl w-full max-w-sm p-6 text-center">
            <button onclick="closeModal('pvp-setup-modal')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-white" id="pvp-title">PvP Arena</h2>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="openLobbyFromSetup()" class="bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500 text-blue-100 py-3 rounded-lg font-bold text-sm">
                    Åpne Lobby
                </button>
                 <button onclick="togglePrivateSetup()" class="bg-slate-700 hover:bg-slate-600 border border-slate-500 text-slate-200 py-3 rounded-lg font-bold text-sm">
                    Privat Kode
                </button>
            </div>

            <!-- Private Code Form (Hidden initially) -->
            <div id="private-setup-form" class="hidden space-y-4 text-left border-t border-slate-700 pt-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Privat Kode</label>
                    <input type="text" id="pvp-room-code" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white font-mono text-center uppercase tracking-widest" placeholder="KODE">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Innsats</label>
                    <input type="number" id="pvp-bet" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white text-center" value="100">
                </div>
                <button onclick="joinPvPRoom()" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg">
                    Gå til Privat Rom
                </button>
            </div>
        </div>
    </div>

    <!-- PvP Arena: RPS -->
    <div id="pvp-rps-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div class="modal-content bg-slate-900 border border-red-500/30 rounded-2xl w-full max-w-lg p-6 relative min-h-[400px] flex flex-col">
            <button onclick="leavePvP()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-xs bg-slate-800 px-2 py-1 rounded">FORLAT KAMP</button>
            <div class="text-center mb-6">
                <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Rom: <span id="rps-room-display" class="text-white font-mono"></span></div>
                <h2 class="text-2xl font-bold text-red-500">Stein, Saks, Papir</h2>
                <div class="text-sm text-yellow-500 font-bold mt-1">Pott: <span id="rps-pot">200</span> kr</div>
            </div>
            <div class="flex-grow flex flex-col justify-center items-center">
                <div id="rps-status" class="text-xl font-bold text-white mb-8 animate-pulse">Venter på motstander...</div>
                <div id="rps-controls" class="hidden flex gap-4">
                    <button onclick="makeRPSMove('rock')" class="w-20 h-20 bg-slate-800 rounded-full border-2 border-slate-600 hover:border-white flex items-center justify-center transition-all hover:scale-110 active:scale-95 group"><i data-lucide="gem" class="w-8 h-8 text-slate-400 group-hover:text-white"></i></button>
                    <button onclick="makeRPSMove('paper')" class="w-20 h-20 bg-slate-800 rounded-full border-2 border-slate-600 hover:border-white flex items-center justify-center transition-all hover:scale-110 active:scale-95 group"><i data-lucide="file" class="w-8 h-8 text-slate-400 group-hover:text-white"></i></button>
                    <button onclick="makeRPSMove('scissors')" class="w-20 h-20 bg-slate-800 rounded-full border-2 border-slate-600 hover:border-white flex items-center justify-center transition-all hover:scale-110 active:scale-95 group"><i data-lucide="scissors" class="w-8 h-8 text-slate-400 group-hover:text-white"></i></button>
                </div>
                <div id="rps-result-area" class="hidden flex items-center gap-8">
                    <div class="text-center"><p class="text-xs text-slate-500 mb-2">DEG</p><div id="my-move-display" class="w-24 h-24 bg-blue-900/50 rounded-xl border border-blue-500 flex items-center justify-center text-4xl">?</div></div>
                    <div class="text-2xl font-black text-slate-600">VS</div>
                    <div class="text-center"><p class="text-xs text-slate-500 mb-2">MOTSTANDER</p><div id="op-move-display" class="w-24 h-24 bg-red-900/50 rounded-xl border border-red-500 flex items-center justify-center text-4xl">?</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PvP Arena: High Card -->
    <div id="pvp-card-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div class="modal-content bg-slate-900 border border-blue-500/30 rounded-2xl w-full max-w-lg p-6 relative min-h-[400px] flex flex-col">
            <button onclick="leavePvP()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-xs bg-slate-800 px-2 py-1 rounded">FORLAT KAMP</button>
            <div class="text-center mb-6">
                <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Rom: <span id="card-room-display" class="text-white font-mono"></span></div>
                <h2 class="text-2xl font-bold text-blue-500">Høyeste Kort</h2>
                <div class="text-sm text-yellow-500 font-bold mt-1">Pott: <span id="card-pot">200</span> kr</div>
            </div>
            <div class="flex-grow flex flex-col justify-center items-center">
                <div id="card-status" class="text-xl font-bold text-white mb-8">Venter på motstander...</div>
                <div id="card-controls" class="hidden">
                    <button onclick="drawPvPCard()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg text-lg animate-pulse">TREKK KORT</button>
                </div>
                <div id="card-result-area" class="hidden flex gap-4">
                    <div id="my-card-display" class="w-24 h-36 bg-white rounded-lg flex items-center justify-center text-black font-bold text-2xl border-4 border-blue-500 transform -rotate-3"></div>
                    <div id="op-card-display" class="w-24 h-36 bg-slate-700 rounded-lg flex items-center justify-center text-white font-bold text-2xl border-4 border-slate-500 transform rotate-3">?</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PvP Arena: Dice Duel (NEW) -->
    <div id="pvp-dice-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div class="modal-content bg-slate-900 border border-green-500/30 rounded-2xl w-full max-w-lg p-6 relative min-h-[400px] flex flex-col">
            <button onclick="leavePvP()" class="absolute top-4 right-4 text-slate-500 hover:text-white text-xs bg-slate-800 px-2 py-1 rounded">FORLAT KAMP</button>
            <div class="text-center mb-6">
                <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Rom: <span id="dice-room-display" class="text-white font-mono"></span></div>
                <h2 class="text-2xl font-bold text-green-500">Terning-Duell</h2>
                <div class="text-sm text-yellow-500 font-bold mt-1">Pott: <span id="dice-pot">200</span> kr</div>
            </div>
            <div class="flex-grow flex flex-col justify-center items-center">
                <div id="dice-status" class="text-xl font-bold text-white mb-8">Venter på motstander...</div>
                <div id="dice-controls" class="hidden">
                    <button onclick="rollPvPDice()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg text-lg animate-pulse">KAST TERNINGER</button>
                </div>
                <div id="dice-result-area" class="hidden grid grid-cols-2 gap-8 w-full">
                    <div class="text-center">
                        <div class="text-sm text-slate-400 mb-2">DEG</div>
                        <div id="my-dice-val" class="text-5xl font-bold text-white mb-2">-</div>
                        <div class="flex justify-center gap-1 opacity-50 text-xs" id="my-dice-details"></div>
                    </div>
                    <div class="text-center border-l border-slate-700">
                        <div class="text-sm text-slate-400 mb-2">MOTSTANDER</div>
                        <div id="op-dice-val" class="text-5xl font-bold text-slate-500 mb-2">-</div>
                        <div class="flex justify-center gap-1 opacity-50 text-xs" id="op-dice-details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SOLO MODALS ===== -->
    <div id="wheel-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4"><div class="modal-content bg-slate-800 border border-slate-600 rounded-2xl w-full max-w-lg shadow-2xl relative p-8 text-center"><button onclick="closeModal('wheel-modal')" class="absolute top-4 right-4 text-slate-400"><i data-lucide="x"></i></button><h2 class="text-2xl font-bold mb-2 text-yellow-400">Akademiet-hjulet</h2><div class="wheel-wrapper mb-8 mt-8"><div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2 z-10 w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[30px] border-t-white drop-shadow-md"></div><div id="wheel-spinner" class="wheel-spinner"><div class="wheel-bg"></div></div></div><button onclick="spinWheel()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-white font-bold py-3 px-8 rounded-full shadow-lg text-xl">SPINN (100 kr)</button></div></div>
    
    <!-- Updated Slots Modal -->
    <div id="slots-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="modal-content bg-slate-900 border border-purple-600 rounded-2xl p-6 text-center w-full max-w-lg">
            <button onclick="closeModal('slots-modal')" class="absolute top-4 right-4 text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold mb-6 text-purple-400">Slots</h2>
            <div class="flex justify-center gap-2 mb-8 bg-black/50 p-4 rounded-xl border border-slate-700">
                <div id="reel-1" class="slot-reel w-24 h-32 bg-slate-800 rounded-lg flex items-center justify-center text-4xl border-2 border-slate-600 overflow-hidden relative">❓</div>
                <div id="reel-2" class="slot-reel w-24 h-32 bg-slate-800 rounded-lg flex items-center justify-center text-4xl border-2 border-slate-600 overflow-hidden relative">❓</div>
                <div id="reel-3" class="slot-reel w-24 h-32 bg-slate-800 rounded-lg flex items-center justify-center text-4xl border-2 border-slate-600 overflow-hidden relative">❓</div>
            </div>
            <button onclick="spinSlots()" id="slot-btn" class="w-full bg-gradient-to-b from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white py-4 rounded-xl font-bold text-xl shadow-lg border-b-4 border-purple-900 active:border-0 active:translate-y-1">SPINN (50kr)</button>
        </div>
    </div>
    
    <div id="blackjack-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4"><div class="modal-content bg-[#1a472a] border-4 border-[#2d5e3e] rounded-xl w-full max-w-lg p-6 text-center"><button onclick="closeModal('blackjack-modal')" class="absolute top-4 right-4 text-white"><i data-lucide="x"></i></button><h2 class="text-2xl font-bold text-green-100 mb-6">Blackjack</h2><div id="bj-dealer-cards" class="flex justify-center gap-2 mb-4 h-24"></div><div id="bj-player-cards" class="flex justify-center gap-2 mb-4 h-24"></div><div id="bj-message" class="text-yellow-400 font-bold mb-2"></div><div id="bj-controls" class="flex justify-center gap-4"><button onclick="startBlackjack()" class="bg-yellow-500 text-black px-6 py-2 rounded">DEAL (100kr)</button></div><div id="bj-actions" class="hidden flex justify-center gap-4"><button onclick="bjHit()" class="bg-blue-600 text-white px-4 py-2 rounded">HIT</button><button onclick="bjStand()" class="bg-red-600 text-white px-4 py-2 rounded">STAND</button></div></div></div>
    <div id="mines-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4"><div class="modal-content bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-blue-400">Mines</h2><button onclick="closeModal('mines-modal')" class="text-slate-400"><i data-lucide="x"></i></button></div><div id="mines-grid" class="grid grid-cols-5 gap-2 mb-4"></div><div class="flex justify-between items-center bg-slate-800 p-3 rounded"><div class="text-sm">Neste: <span id="mines-next-reward" class="text-green-400 font-bold">1.2x</span></div><button id="mines-cashout" onclick="cashoutMines()" class="bg-green-600 px-4 py-1 rounded text-sm font-bold opacity-50 cursor-not-allowed" disabled>Hent Gevinst</button></div><button id="mines-start" onclick="startMines()" class="w-full mt-4 bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold">Start (50 kr)</button></div></div>

    <script>
        // --- SOUND ENGINE ---
        const SoundEngine = {
            sounds: {
                win: new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'),
                coin: new Audio('https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3'),
                spin: new Audio('https://www.soundjay.com/button/sounds/button-30.mp3'),
                loss: new Audio('https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3'),
                click: new Audio('https://www.soundjay.com/button/sounds/button-16.mp3')
            },
            play: function(name) { 
                try { 
                    this.sounds[name].currentTime = 0; 
                    const p = this.sounds[name].play(); 
                    if(p !== undefined) p.catch(e => console.log("Audio play failed (interaction needed?):", e));
                } catch(e){ console.log("Audio Error:", e); } 
            }
        };

        // --- RADIO LOGIC ---
        const audioEl = document.getElementById('audio-element');
        const radioIcon = document.getElementById('radio-icon');
        let isPlaying = false;

        function togglePlayMusic() {
            if(isPlaying) {
                audioEl.pause();
                radioIcon.setAttribute('data-lucide', 'play');
            } else {
                audioEl.play().catch(e => alert("Kunne ikke starte radio. Sjekk internett/brannmur."));
                radioIcon.setAttribute('data-lucide', 'pause');
            }
            isPlaying = !isPlaying;
            lucide.createIcons();
        }

        function changeStation() {
            const url = document.getElementById('radio-select').value;
            audioEl.src = url;
            if(isPlaying) audioEl.play();
        }

        function changeVolume(val) {
            audioEl.volume = val;
        }

        // --- GLOBAL STATE ---
        let state = { username: '', balance: 0, inventory: [], isLoggedIn: false, hasClaimedBonus: false };
        
        // --- GUN SETUP & ERROR HANDLING ---
        // Simplified: NO SEA / Encryption. Just plain Gun.
        let gun, appScope;
        try {
            gun = Gun(['https://gun-manhattan.herokuapp.com/gun']); // Public relay
            // Version bumping to clear old data structures
            appScope = gun.get('videregaende-gambling-pvp-v4-simple'); 
        } catch(e) {
            console.error("GUN.JS BLOCKED:", e);
            alert("Advarsel: Skolenettet blokkerer trolig multiplayer-motoren (Gun.js). PvP vil ikke fungere.");
        }
        
        let myId = sessionStorage.getItem('vg_uuid');
        if(!myId) { myId = crypto.randomUUID(); sessionStorage.setItem('vg_uuid', myId); }

        window.onload = function() {
            lucide.createIcons();
            
            // Check local persistence first
            const local = localStorage.getItem('vg_gambling_data_v6');
            if(local) {
                const parsed = JSON.parse(local);
                // If we have a saved username/login, we trust it for "auto-login"
                if(parsed.isLoggedIn && parsed.username) {
                    state = parsed;
                    // Attempt to fetch fresh data from Gun, but don't block
                    if(gun) {
                        gun.get('users').get(state.username).once((data) => {
                            if(data) {
                                // Sync found!
                                if(data.balance) state.balance = data.balance;
                                if(data.inventory) state.inventory = JSON.parse(data.inventory || "[]");
                                saveState(); // re-save locally
                                updateUI();
                            }
                        });
                    }
                    showDashboard();
                } else {
                    document.getElementById('landing-page').style.display = 'flex';
                }
            } else {
                document.getElementById('landing-page').style.display = 'flex';
            }

            generateWheelIcons();
            initMines();
        };

        function showDashboard() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('dashboard').style.display = 'flex';
            updateUI();
        }

        function saveState() {
            // Dual Save: Local + Gun (Unencrypted)
            localStorage.setItem('vg_gambling_data_v6', JSON.stringify(state));
            
            if(gun && state.username) {
                // Storing plain data under 'users/username'
                gun.get('users').get(state.username).put({
                    username: state.username, // keep for ref
                    password: state.password, // Stored plain as requested
                    balance: state.balance,
                    inventory: JSON.stringify(state.inventory),
                    hasClaimedBonus: state.hasClaimedBonus
                });
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('display-username').textContent = state.username;
            document.getElementById('user-balance').innerText = state.balance + ' kr'; 
            document.getElementById('settings-username').innerText = state.username || '-';
            renderInventory();
        }

        function renderInventory() {
            const el = document.getElementById('inventory-list');
            el.innerHTML = state.inventory.length ? state.inventory.map(i => `<div class="bg-slate-700 p-2 rounded text-center"><div class="text-xl">${i.icon}</div><div class="text-xs truncate">${i.name}</div></div>`).join('') : '<div class="text-slate-500 text-xs col-span-full text-center">Tomt.</div>';
        }

        // --- MODAL HELPERS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); lucide.createIcons(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // --- AUTH (SIMPLE) ---
        function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const username = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value.trim();

            if(!username || !password) return alert("Fyll ut begge felt!");

            if(!gun) return alert("Gun.js er ikke lastet. Sjekk nettverk.");

            btn.querySelector('.btn-text').style.display='none'; 
            btn.querySelector('.feide-loader').style.display='block';
            
            // Check if user exists
            gun.get('users').get(username).once((data) => {
                if(data && data.password) {
                    // User exists, check password
                    if(data.password === password) {
                        // Success
                        finishLogin(data);
                    } else {
                        // Fail
                        alert("Feil passord!");
                        btn.querySelector('.btn-text').style.display='block'; 
                        btn.querySelector('.feide-loader').style.display='none';
                    }
                } else {
                    // User does not exist, CREATE IT
                    const newUser = {
                        username: username,
                        password: password,
                        balance: 500, // Bonus logic handled here ideally or later
                        inventory: "[]",
                        hasClaimedBonus: true
                    };
                    // Save to network
                    gun.get('users').get(username).put(newUser);
                    
                    // Show "Created" msg (optional), then login
                    finishLogin(newUser);
                }
            });
        }

        function finishLogin(userData) {
            const btn = document.getElementById('login-btn');
            btn.querySelector('.feide-loader').style.display='none';
            btn.querySelector('.feide-success').style.display='flex';
            
            setTimeout(() => {
                state.username = userData.username;
                state.password = userData.password; // Store locall too to re-save
                state.balance = userData.balance !== undefined ? userData.balance : 0;
                state.inventory = userData.inventory ? JSON.parse(userData.inventory) : [];
                state.hasClaimedBonus = userData.hasClaimedBonus;
                state.isLoggedIn = true;
                
                // Show bonus modal if brand new (simulated via local state check mostly, but if forced from gun data)
                // If creating new user, we set balance 500 directly.
                // We'll just show the modal if it was a fresh creation visual
                if(state.balance === 500 && state.inventory.length === 0) {
                     setTimeout(() => openModal('bonus-modal'), 500);
                }

                saveState();
                closeModal('login-modal');
                showDashboard();
            }, 800);
        }

        function logout() { 
            state.isLoggedIn = false; 
            localStorage.removeItem('vg_gambling_data_v6'); 
            location.reload(); 
        }
        
        function resetData() { 
            if(confirm("Dette sletter kun lokal info. Brukeren din på nettverket består.")) {
                logout();
            }
        }
        
        function processFunds() {
            const amount = parseInt(document.getElementById('fund-amount').value);
            if(!amount || amount <= 0) return alert("Ugyldig beløp");
            const btn = document.getElementById('fund-btn');
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> Sender...`;
            lucide.createIcons();
            setTimeout(() => {
                state.balance += amount;
                saveState();
                closeModal('add-funds-modal');
                SoundEngine.play('coin');
                btn.innerHTML = `<span id="fund-text">Send Faktura</span>`;
                alert(`Faktura på ${amount} kr sendt til skolen. (Beløp lagt til).`);
            }, 1500);
        }

        // --- CLAIM PRIZES FIX ---
        function claimPrizes() {
            const school = document.getElementById('claim-school').value;
            if(!school) return alert("Skriv inn navnet på skolen!");
            
            if(state.inventory.length === 0) {
                return alert("Sekken din er tom! Du har ingenting å sende.");
            }

            const itemCount = state.inventory.length;
            state.inventory = [];
            saveState();
            
            SoundEngine.play('win');
            alert(`Suksess! ${itemCount} premier er pakket og sendt til ${school}.`);
            closeModal('claim-prize-modal');
            document.getElementById('claim-school').value = ''; 
        }

        // --- LOBBY SYSTEM ---
        function openLobby() {
            openModal('lobby-modal');
            listPublicRooms();
        }
        function switchTab(tab) {
            if(tab === 'list') {
                document.getElementById('view-list').classList.remove('hidden');
                document.getElementById('view-host').classList.add('hidden');
                document.getElementById('tab-list').className = "flex-1 py-3 text-sm font-bold text-blue-400 border-b-2 border-blue-400 bg-slate-800";
                document.getElementById('tab-host').className = "flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-200";
                listPublicRooms();
            } else {
                document.getElementById('view-list').classList.add('hidden');
                document.getElementById('view-host').classList.remove('hidden');
                document.getElementById('tab-list').className = "flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-200";
                document.getElementById('tab-host').className = "flex-1 py-3 text-sm font-bold text-blue-400 border-b-2 border-blue-400 bg-slate-800";
            }
        }

        function createPublicRoom() {
            const name = document.getElementById('host-name').value || "Ukjent Rom";
            const game = document.getElementById('host-game').value;
            const bet = parseInt(document.getElementById('host-bet').value) || 100;
            
            const roomId = "PUB_" + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Initial Room Data
            if(appScope) {
                appScope.get('public_rooms').get(roomId).put({
                    id: roomId,
                    name: name,
                    game: game,
                    bet: bet,
                    host: state.username,
                    players: 0,
                    lastActive: Date.now()
                });
            }

            // Auto-join
            document.getElementById('pvp-room-code').value = roomId;
            document.getElementById('pvp-bet').value = bet;
            
            closeModal('lobby-modal');
            
            // Trigger join logic
            setTimeout(() => {
                pvpGameType = game; // Set global
                joinPvPRoom(true); // true = bypass bet check visual (handled inside)
            }, 500);
        }

        function listPublicRooms() {
            const container = document.getElementById('rooms-container');
            container.innerHTML = "";
            let found = false;
            
            if(!appScope) return;

            appScope.get('public_rooms').map().once((data, id) => {
                if(!data || !data.id) return;
                
                // Cleanup: Check if inactive > 5 mins (300000ms)
                if(Date.now() - data.lastActive > 300000) return;

                found = true;
                const isFull = data.players >= 2;
                const gameNames = {rps: "Stein Saks Papir", card: "Høyeste Kort", dice: "Terning-Duell"};
                
                const el = document.createElement('div');
                el.className = `room-item bg-slate-800 border ${isFull ? 'border-red-900 opacity-60' : 'border-slate-700'} p-4 rounded-lg flex justify-between items-center transition-all cursor-pointer`;
                el.onclick = () => {
                    if(isFull) return alert("Rommet er fullt!");
                    document.getElementById('pvp-room-code').value = data.id;
                    document.getElementById('pvp-bet').value = data.bet;
                    pvpGameType = data.game;
                    closeModal('lobby-modal');
                    joinPvPRoom(true);
                };

                el.innerHTML = `
                    <div>
                        <div class="font-bold text-white">${data.name}</div>
                        <div class="text-xs text-slate-400">${gameNames[data.game] || data.game} • <span class="text-green-400">${data.bet} kr</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold ${isFull ? 'text-red-500' : 'text-blue-400'}">${data.players}/2</div>
                        <div class="text-[10px] text-slate-600">${data.id}</div>
                    </div>
                `;
                container.appendChild(el);
            });
            
            // Fallback text if Gun is slow or empty (visual only)
            setTimeout(() => {
                if(container.innerHTML === "") container.innerHTML = `<div class="text-center text-slate-500 text-sm">Ingen åpne rom funnet. Lag et selv!</div>`;
            }, 1000);
        }

        // --- PVP LOGIC ---
        let pvpRoom = null;
        let pvpGameType = ''; // 'rps', 'card', 'dice'
        let pvpBet = 0;
        let pvpSub = null;
        let playerNum = 0; // 1 or 2
        let currentRoomId = null;

        function openPvPSetup(type) {
            pvpGameType = type;
            document.getElementById('pvp-title').innerText = type === 'dice' ? 'Terning-Duell' : (type === 'rps' ? 'Stein Saks Papir' : 'Høyeste Kort');
            openModal('pvp-setup-modal');
        }
        function openLobbyFromSetup() { closeModal('pvp-setup-modal'); openLobby(); }
        function togglePrivateSetup() { document.getElementById('private-setup-form').classList.toggle('hidden'); }

        function joinPvPRoom(fromLobby = false) {
            const code = document.getElementById('pvp-room-code').value.trim().toUpperCase();
            const bet = parseInt(document.getElementById('pvp-bet').value);
            
            if(!code) return alert("Mangler rom-kode!");
            if(state.balance < bet) return alert("Du har ikke nok penger!");
            if(!appScope) return alert("PvP er deaktivert (Gun.js blokkert).");

            // Deduct bet
            state.balance -= bet;
            saveState();
            pvpBet = bet;
            currentRoomId = code;

            // Check if Public Room node exists to update player count
            if(code.startsWith('PUB_')) {
                 const pubNode = appScope.get('public_rooms').get(code);
                 pubNode.once(d => {
                     if(d && d.players < 2) {
                         pubNode.get('players').put(d.players + 1);
                         pubNode.get('lastActive').put(Date.now()); // heartbeat on join
                     }
                 });
                 // Start heartbeat loop
                 setInterval(() => {
                     appScope.get('public_rooms').get(code).get('lastActive').put(Date.now());
                 }, 60000);
            }

            pvpRoom = appScope.get('rooms').get(code);
            closeModal('pvp-setup-modal');
            
            if(pvpGameType === 'rps') {
                openModal('pvp-rps-modal');
                document.getElementById('rps-room-display').innerText = code;
                document.getElementById('rps-pot').innerText = bet * 2;
                initRPSGame();
            } else if (pvpGameType === 'card') {
                openModal('pvp-card-modal');
                document.getElementById('card-room-display').innerText = code;
                document.getElementById('card-pot').innerText = bet * 2;
                initCardGame();
            } else if (pvpGameType === 'dice') {
                openModal('pvp-dice-modal');
                document.getElementById('dice-room-display').innerText = code;
                document.getElementById('dice-pot').innerText = bet * 2;
                initDiceGame();
            }
        }

        function leavePvP() {
            // Decrement player count if public
            if(currentRoomId && currentRoomId.startsWith('PUB_') && appScope) {
                const n = appScope.get('public_rooms').get(currentRoomId);
                n.once(d => { if(d && d.players > 0) n.get('players').put(d.players - 1); });
            }
            alert("Du forlot kampen. Innsatsen er tapt.");
            location.reload(); 
        }

        // --- GAME: RPS ---
        function initRPSGame() {
            const rpsNode = pvpRoom.get('rps_round_' + Math.floor(Date.now() / 600000));
            rpsNode.get('p1').once((d) => {
                if(!d || (Date.now() - d.ts > 10000)) { playerNum = 1; rpsNode.get('p1').put({id: myId, ts: Date.now(), move: false}); document.getElementById('rps-status').innerText = "Venter på motstander..."; } 
                else if (d.id !== myId) { playerNum = 2; rpsNode.get('p2').put({id: myId, ts: Date.now(), move: false}); document.getElementById('rps-status').innerText = "Spiller 2 tilkoblet!"; } 
                else playerNum = 1;
            });
            pvpSub = rpsNode.on((data) => {
                if(!data || !data.p1 || !data.p2) return;
                const myMove = playerNum === 1 ? data.p1.move : data.p2.move;
                const opMove = playerNum === 1 ? data.p2.move : data.p1.move;

                if(!myMove && !opMove) { document.getElementById('rps-status').innerText = "Velg ditt trekk!"; document.getElementById('rps-controls').classList.remove('hidden'); document.getElementById('rps-result-area').classList.add('hidden'); } 
                else if (myMove && !opMove) { document.getElementById('rps-status').innerText = "Venter på motstander..."; document.getElementById('rps-controls').classList.add('hidden'); }
                else if (myMove && opMove) { resolveRPS(myMove, opMove); }
            });
        }
        function makeRPSMove(move) {
            const rpsNode = pvpRoom.get('rps_round_' + Math.floor(Date.now() / 600000));
            if(playerNum === 1) rpsNode.get('p1').get('move').put(move); else rpsNode.get('p2').get('move').put(move);
        }
        function resolveRPS(myMove, opMove) {
            document.getElementById('rps-controls').classList.add('hidden'); document.getElementById('rps-result-area').classList.remove('hidden');
            const icons = {rock: 'gem', paper: 'file', scissors: 'scissors'};
            document.getElementById('my-move-display').innerHTML = `<i data-lucide="${icons[myMove]}" class="w-12 h-12 text-blue-300"></i>`;
            document.getElementById('op-move-display').innerHTML = `<i data-lucide="${icons[opMove]}" class="w-12 h-12 text-red-300"></i>`;
            lucide.createIcons();
            let result = (myMove === opMove) ? 'draw' : ((myMove=='rock'&&opMove=='scissors')||(myMove=='paper'&&opMove=='rock')||(myMove=='scissors'&&opMove=='paper')) ? 'win' : 'lose';
            handlePvPResult(result, 'rps-status');
        }

        // --- GAME: HIGH CARD ---
        function initCardGame() {
            const node = pvpRoom.get('card_round_' + Math.floor(Date.now() / 600000));
            node.get('p1').once((d) => {
                if(!d || (Date.now() - d.ts > 10000)) { playerNum = 1; node.get('p1').put({id: myId, ts: Date.now(), card: 0}); document.getElementById('card-status').innerText = "Venter på motstander..."; } 
                else if (d.id !== myId) { playerNum = 2; node.get('p2').put({id: myId, ts: Date.now(), card: 0}); document.getElementById('card-status').innerText = "Spiller 2 tilkoblet!"; } 
                else playerNum = 1;
            });
            node.on((data) => {
                if(!data || !data.p1 || !data.p2) return;
                const myCard = playerNum === 1 ? data.p1.card : data.p2.card;
                const opCard = playerNum === 1 ? data.p2.card : data.p1.card;
                if(myCard === 0 && opCard === 0) { document.getElementById('card-controls').classList.remove('hidden'); document.getElementById('card-result-area').classList.add('hidden'); }
                else if (myCard > 0 && opCard === 0) { document.getElementById('card-status').innerText = "Venter på motstander..."; document.getElementById('card-controls').classList.add('hidden'); }
                else if (myCard > 0 && opCard > 0) { resolveCardGame(myCard, opCard); }
            });
        }
        function drawPvPCard() {
            const val = Math.ceil(Math.random() * 13) + 1; 
            const node = pvpRoom.get('card_round_' + Math.floor(Date.now() / 600000));
            if(playerNum === 1) node.get('p1').get('card').put(val); else node.get('p2').get('card').put(val);
        }
        function resolveCardGame(my, op) {
            document.getElementById('card-controls').classList.add('hidden'); document.getElementById('card-result-area').classList.remove('hidden');
            const map = {11:'J', 12:'Q', 13:'K', 14:'A'};
            document.getElementById('my-card-display').innerText = map[my] || my; document.getElementById('op-card-display').innerText = map[op] || op;
            document.getElementById('op-card-display').className = "w-24 h-36 bg-white rounded-lg flex items-center justify-center text-black font-bold text-2xl border-4 border-slate-500 transform rotate-3";
            let res = (my > op) ? 'win' : (my < op) ? 'lose' : 'draw';
            handlePvPResult(res, 'card-status');
        }

        // --- GAME: DICE DUEL ---
        function initDiceGame() {
            const node = pvpRoom.get('dice_round_' + Math.floor(Date.now() / 600000));
            node.get('p1').once((d) => {
                if(!d || (Date.now() - d.ts > 10000)) { playerNum = 1; node.get('p1').put({id: myId, ts: Date.now(), val: 0, rolls: "0,0,0"}); document.getElementById('dice-status').innerText = "Venter på motstander..."; }
                else if (d.id !== myId) { playerNum = 2; node.get('p2').put({id: myId, ts: Date.now(), val: 0, rolls: "0,0,0"}); document.getElementById('dice-status').innerText = "Spiller 2 tilkoblet!"; }
                else playerNum = 1;
            });
            node.on((data) => {
                if(!data || !data.p1 || !data.p2) return;
                const myD = playerNum === 1 ? data.p1 : data.p2;
                const opD = playerNum === 1 ? data.p2 : data.p1;
                
                if(myD.val === 0 && opD.val === 0) { document.getElementById('dice-controls').classList.remove('hidden'); document.getElementById('dice-result-area').classList.add('hidden'); }
                else if (myD.val > 0 && opD.val === 0) { document.getElementById('dice-status').innerText = "Venter på motstander..."; document.getElementById('dice-controls').classList.add('hidden'); }
                else if (myD.val > 0 && opD.val > 0) { resolveDiceGame(myD, opD); }
            });
        }
        function rollPvPDice() {
            const r1 = Math.ceil(Math.random()*6); const r2 = Math.ceil(Math.random()*6); const r3 = Math.ceil(Math.random()*6);
            const sum = r1+r2+r3;
            const node = pvpRoom.get('dice_round_' + Math.floor(Date.now() / 600000));
            const data = {val: sum, rolls: `${r1},${r2},${r3}`};
            if(playerNum === 1) node.get('p1').put(data); else node.get('p2').put(data);
        }
        function resolveDiceGame(my, op) {
            document.getElementById('dice-controls').classList.add('hidden'); document.getElementById('dice-result-area').classList.remove('hidden');
            document.getElementById('my-dice-val').innerText = my.val; document.getElementById('op-dice-val').innerText = op.val;
            document.getElementById('my-dice-details').innerText = `(${my.rolls})`; document.getElementById('op-dice-details').innerText = `(${op.rolls})`;
            let res = (my.val > op.val) ? 'win' : (my.val < op.val) ? 'lose' : 'draw';
            handlePvPResult(res, 'dice-status');
        }

        // --- SHARED PVP UTILS ---
        function handlePvPResult(result, statusId) {
            const el = document.getElementById(statusId);
            if(document.body.classList.contains('paid_pvp')) return;
            if(result === 'win') {
                el.innerText = "DU VANT!"; el.classList.add('text-green-500');
                state.balance += (pvpBet * 2); SoundEngine.play('win');
            } else if (result === 'lose') {
                el.innerText = "DU TAPTE..."; el.classList.add('text-red-500');
                SoundEngine.play('loss');
            } else {
                el.innerText = "UAVGJORT! Pengene tilbake.";
                state.balance += pvpBet;
            }
            saveState();
            document.body.classList.add('paid_pvp');
            setTimeout(() => document.body.classList.remove('paid_pvp'), 5000);
        }

        // --- SOLO GAMES (Fixed Slots) ---
        const wheelPrizes = [{n:"Energidrikk",i:"cup-soda"},{n:"MacBook Air",i:"laptop"},{n:"Gammelt Eple",i:"apple"},{n:"Penn & Papir",i:"pencil"},{n:"Akademiet Sekk",i:"backpack"},{n:"Energidrikk",i:"cup-soda"},{n:"Headset",i:"headphones"},{n:"Penn",i:"pencil"}];
        function generateWheelIcons() {
            const s = document.getElementById('wheel-spinner');
            wheelPrizes.forEach((p,i)=>{ const d=document.createElement('div'); d.className='wheel-icon'; d.style.transform=`rotate(${i*45+22.5}deg)`; d.innerHTML=`<i data-lucide="${p.i}" class="w-8 h-8 mb-1"></i>`; s.appendChild(d); });
        }
        function spinWheel() {
            if(state.balance<100) return alert('Tomt for penger'); state.balance-=100; saveState();
            const s = document.getElementById('wheel-spinner');
            const rot = 1800 + Math.floor(Math.random()*360);
            s.style.transform=`rotate(-${rot}deg)`; SoundEngine.play('spin');
            setTimeout(()=>{
                const idx = Math.floor((rot%360)/45); const p = wheelPrizes[idx];
                document.getElementById('win-message').innerText = p.n === "MacBook Air" ? "DU VANT MACBOOK!" : `Du vant: ${p.n}`;
                openModal('win-modal'); state.inventory.push({name:p.n, icon: `<i data-lucide="${p.i}"></i>`}); saveState(); SoundEngine.play('win');
            }, 5000);
        }

        // Improved Slots Logic
        function spinSlots() {
            if(state.balance < 50) return alert("Mangler penger");
            state.balance -= 50; 
            saveState();

            const reels = [1,2,3].map(i => document.getElementById(`reel-${i}`));
            const icons = ['cherry', 'gem', 'bell', 'grape', 'clover'];
            
            // Add Blur
            reels.forEach(r => r.classList.add('slot-spinning'));
            SoundEngine.play('spin');

            let finalRes = [];

            // Reel 1 stop
            setTimeout(() => {
                reels[0].classList.remove('slot-spinning');
                const r1 = icons[Math.floor(Math.random() * icons.length)];
                finalRes.push(r1);
                reels[0].innerHTML = `<i data-lucide="${r1}"></i>`;
                lucide.createIcons();
                SoundEngine.play('click');

                // Reel 2 stop
                setTimeout(() => {
                    reels[1].classList.remove('slot-spinning');
                    const r2 = icons[Math.floor(Math.random() * icons.length)];
                    finalRes.push(r2);
                    reels[1].innerHTML = `<i data-lucide="${r2}"></i>`;
                    lucide.createIcons();
                    SoundEngine.play('click');

                    // Reel 3 stop
                    setTimeout(() => {
                        reels[2].classList.remove('slot-spinning');
                        const r3 = icons[Math.floor(Math.random() * icons.length)];
                        finalRes.push(r3);
                        reels[2].innerHTML = `<i data-lucide="${r3}"></i>`;
                        lucide.createIcons();
                        SoundEngine.play('click');

                        // Check Win
                        if(r1 === r2 && r2 === r3) {
                            setTimeout(() => {
                                SoundEngine.play('win');
                                document.getElementById('win-message').innerText = "JACKPOT! 1000kr!";
                                state.balance += 1000;
                                saveState();
                                openModal('win-modal');
                            }, 300);
                        } else if (r1 === r2 || r2 === r3 || r1 === r3) {
                            setTimeout(() => {
                                SoundEngine.play('coin'); // Small win
                                state.balance += 50; // Money back
                                saveState();
                                // Optional visual for small win
                            }, 300);
                        }

                    }, 500);
                }, 500);
            }, 1000);
        }

        // Mines logic
        let minesActive=false; let minesM=1.0; let minesG=[];
        function initMines() {
            document.getElementById('mines-grid').innerHTML = Array(25).fill(0).map((_,i)=>`<div id="mine-${i}" class="w-full h-10 bg-slate-700 rounded cursor-pointer hover:bg-slate-600 border border-slate-600" onclick="clickMine(${i})"></div>`).join('');
        }
        function startMines(){
            if(state.balance<50) return alert("Tomt"); state.balance-=50; saveState(); minesActive=true; minesM=1.0; minesG=Array(25).fill(0);
            let p=0; while(p<5){ let x=Math.floor(Math.random()*25); if(minesG[x]===0){minesG[x]=1; p++;}}
            initMines();
        }
        function clickMine(i){
            if(!minesActive)return; const el=document.getElementById(`mine-${i}`);
            if(minesG[i]===1) { el.classList.add('bg-red-500'); SoundEngine.play('loss'); minesActive=false; alert('BOOM'); }
            else { el.classList.add('bg-green-500'); minesM+=0.2; document.getElementById('mines-next-reward').innerText=minesM.toFixed(1)+'x'; SoundEngine.play('coin'); document.getElementById('mines-cashout').disabled=false; document.getElementById('mines-cashout').classList.remove('opacity-50'); }
        }
        function cashoutMines(){ if(!minesActive)return; state.balance+=Math.floor(50*minesM); saveState(); minesActive=false; alert('Gevinst!'); initMines(); document.getElementById('mines-cashout').disabled=true; document.getElementById('mines-cashout').classList.add('opacity-50'); }
        
        // --- BLACKJACK LOGIC ---
        let bjDeck = [], bjPlayerHand = [], bjDealerHand = [], bjActive = false;

        function getCard() {
            const vals = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            const suits = ['♠','♥','♦','♣'];
            const val = vals[Math.floor(Math.random()*vals.length)];
            const suit = suits[Math.floor(Math.random()*suits.length)];
            let num = parseInt(val);
            if(['J','Q','K'].includes(val)) num = 10;
            if(val === 'A') num = 11;
            return { val, suit, num, color: (suit === '♥' || suit === '♦') ? 'text-red-500' : 'text-black' };
        }

        function drawCardUI(card, containerId) {
            const el = document.createElement('div');
            el.className = `w-16 h-24 bg-white rounded flex flex-col items-center justify-center font-bold border-2 border-gray-300 ${card.color}`;
            let suitIcon = '';
            if(card.suit === '♥') suitIcon = '<i data-lucide="heart" class="w-4 h-4 fill-red-500"></i>';
            else if(card.suit === '♦') suitIcon = '<i data-lucide="diamond" class="w-4 h-4 fill-red-500"></i>';
            else if(card.suit === '♠') suitIcon = '<i data-lucide="spade" class="w-4 h-4 fill-black"></i>';
            else if(card.suit === '♣') suitIcon = '<i data-lucide="club" class="w-4 h-4 fill-black"></i>';
            
            el.innerHTML = `<span>${card.val}</span><div class="mt-1">${suitIcon}</div>`;
            document.getElementById(containerId).appendChild(el);
            lucide.createIcons();
        }

        function calcHand(hand) {
            let sum = hand.reduce((a,b) => a + b.num, 0);
            let aces = hand.filter(c => c.val === 'A').length;
            while(sum > 21 && aces > 0) { sum -= 10; aces--; }
            return sum;
        }

        function startBlackjack() {
            if(state.balance < 100) return alert("Tom for penger");
            state.balance -= 100;
            saveState();
            
            // Reset UI
            document.getElementById('bj-dealer-cards').innerHTML = '';
            document.getElementById('bj-player-cards').innerHTML = '';
            document.getElementById('bj-message').innerText = '';
            
            bjPlayerHand = [getCard(), getCard()];
            bjDealerHand = [getCard()]; 
            
            bjPlayerHand.forEach(c => drawCardUI(c, 'bj-player-cards'));
            bjDealerHand.forEach(c => drawCardUI(c, 'bj-dealer-cards'));
            
            document.getElementById('bj-controls').classList.add('hidden');
            document.getElementById('bj-actions').classList.remove('hidden');
            bjActive = true;
            
            if(calcHand(bjPlayerHand) === 21) bjStand(); 
        }

        function bjHit() {
            if(!bjActive) return;
            const card = getCard();
            bjPlayerHand.push(card);
            drawCardUI(card, 'bj-player-cards');
            if(calcHand(bjPlayerHand) > 21) {
                bjActive = false;
                document.getElementById('bj-message').innerText = "BUST! (Over 21)";
                document.getElementById('bj-actions').classList.add('hidden');
                document.getElementById('bj-controls').classList.remove('hidden');
                SoundEngine.play('loss');
            }
        }

        function bjStand() {
            if(!bjActive) return;
            bjActive = false;
            while(calcHand(bjDealerHand) < 17) {
                const c = getCard();
                bjDealerHand.push(c);
                drawCardUI(c, 'bj-dealer-cards');
            }
            
            const pScore = calcHand(bjPlayerHand);
            const dScore = calcHand(bjDealerHand);
            
            let msg = "";
            let win = 0;
            
            if(dScore > 21) { msg = "Dealer Busted! Du vant!"; win = 200; }
            else if(pScore > dScore) { msg = "Du vant!"; win = 200; }
            else if(pScore === dScore) { msg = "Uavgjort (Push)"; win = 100; }
            else { msg = "Huset vant."; }
            
            document.getElementById('bj-message').innerText = msg;
            if(win > 0) { 
                handleWin(win); 
                state.balance += win; // Ensure balance updates here if handleWin doesn't
                saveState();
            } else { 
                SoundEngine.play('loss'); 
            }
            
            document.getElementById('bj-actions').classList.add('hidden');
            document.getElementById('bj-controls').classList.remove('hidden');
        }

        function handleWin(amount) {
             SoundEngine.play('win');
             // Logic to show modal if desired, or just sound
        }
    </script>
</body>
</html>
